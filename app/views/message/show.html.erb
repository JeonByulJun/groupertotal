<div class="row">
  <div class="col-sm-2">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h4 class="panel-title">
            <a href="/chat/show?team=<%=@team.id%>" data-parent="#accordion" aria-expanded="true" aria-controls="collapseOne" style="font-family: 'Jeju Gothic', sans-serif;">
              팀 홈으로 가기<span class="glyphicon glyphicon-home" aria-hidden="true"></span>
            </a>
          </h4>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h4 class="panel-title">
          <% temp = [] %>
          <% temp += @team.users.order(first_name: :asc) %>
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              멤버 <small><%=temp.count%>명</small> <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
            </a>
          </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body" style="max-height: 300px;overflow: auto;">
            <div class="row">
              <div class="col-sm-12">
                <form action="/team/addmember" method="get">
                  <input type="hidden" name="team" value="<%=@team.id%>"/>
                  <button type="submit" class="btn btn-new btn-xs" style="width: 100%;" data-toggle="tooltip" data-placement="bottom" title="팀원 추가"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                </form>
                <hr />
              </div>
              <div id="profile_me" class="col-sm-12">
                <img class="img-circle" alt="profile" src="<%=current_user.image%>" style="width: 35px; height: 35px;">
                <%=current_user.first_name%>
                <% temp.each_with_index do |t,idx| %>
                  <% if t.id != current_user.id %>
                    <br><img style="width: 35px; height: 35px;" class="img-circle" alt="profile" src="<%=t.image%>">
                    <%=t.first_name%>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingTwo">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              채팅방 <span class="glyphicon glyphicon-comment" aria-hidden="true"></span>
            </a>
          </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo" >
          <div class="panel-body" style="max-height: 300px;overflow: auto;">
            <div class="row">
              <div class="col-sm-12">
                <div data-toggle="tooltip" data-placement="bottom" title="채팅방 추가">
                  <button class="btn btn-new btn-xs" style="width: 100%;" type="button" data-toggle="collapse" data-placement="bottom" data-target="#addchatroom2" aria-expanded="false" aria-controls="addchatroom"><span class="glyphicon glyphicon-plus"></span></button>
                </div>
                <hr />
              </div>
            </div>

            <div class="row collapse" id="addchatroom2">
              <div class="col-sm-12">
                <form action="/chat/create" method="post">
                  <input  class="form-control" type="text" name="title" placeholder="방 이름 입력" required>
                  <br>
                  <input type="hidden" name="team" value="<%=@team.id%>">
                  <% temp.each_with_index do |t,idx| %>
                    <% if t.id != current_user.id %>
                      <div id="profile<%=idx%>">
                        <div class="row">
                          <div class="col-xs-3">
                            <img class="img-circle" alt="profile" src="<%=t.image%>" style="width: 35px; height: 35px;">
                          </div>
                          <div class="col-xs-6">
                            <%=t.first_name%>
                          </div>
                          <div id="profile_me" class="col-xs-3 checkbox">
                            <%= check_box_tag('user_ids[]', t.id) %>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                  <br>
                  <button type="submit" value="send" class="btn btn-new btn-sm" aria-haspopup="true" aria-expanded="false" style="width: 100%">
                    방 만들기
                  </button>
                  <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
                </form>
                <hr />
              </div>
            </div>

            <div class="row">
              <div class="col-sm-12">
                <% if @chats %>
                  <% @chats.each do |chat| %>
                    <div class="well well-sm" style="cursor: pointer;" onclick="$('#chat<%=chat.id%>').submit();">
                      <p><%=chat.title%></p>
                      <form id="chat<%=chat.id%>" action ="/message/show" method="get">
                        <input type="hidden" name="chat" value="<%=chat.id%>">
                        <input type="hidden" name="team" value="<%=@team.id%>">
                      </form>
                      <form action="/chat/deletemember" method="post">
                        <input type="hidden" name="chat" value="<%=chat.id%>">
                        <input type="hidden" name="team" value="<%=@team.id%>">
                        <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
                        <div class="row">
                          <div class="col-sm-9">
                            <% chat.users.each do |inchat| %>
                              <img class="img-circle" data-toggle="tooltip" data-placement="top" title="<%=inchat.first_name%>" src="<%=inchat.image%>" style="width: 20px; height: 20px;">
                            <% end %>
                          </div>
                          <div class="col-sm-3">
                            <button class="btn btn-danger btn-xs" type="submit" style="float:right;"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span></button>
                          </div>
                        </div>
                      </form>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
              작업 분배 <span class="glyphicon glyphicon-hand-right" aria-hidden="true"></span>
            </a>
          </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body" style="max-height: 300px;overflow: auto;">
            <div class="row">
              <div class="col-sm-12">
                <div data-toggle="tooltip" data-placement="bottom" title="작업 추가">
                  <button class="btn btn-new btn-xs" style="width: 100%;" type="button" data-toggle="collapse" data-target="#givetask" aria-expanded="false" aria-controls="collapseExample">
                  <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                </div>
              </div>
            </div>
            <div class="row collapse" id="givetask">
              <form action="/task/create" method="post">
                <div class="col-sm-12">
                  <hr />
                  <input type="text" class="form-control" name="taskname" id="taskname_text" placeholder="작업의 이름 입력" required>
                  <br>
                  <div class="form-group">
                    <div class='input-group date' id='datetimepicker1'>
                      <input type='text' class="form-control" placeholder="마감일 설정" name="duedate" required>
                      <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                      </span>
                    </div>
                  </div>
                </div>

                <script type="text/javascript">
                  $(function () {
                    $('#datetimepicker1').datetimepicker({
                      format : 'YYYY-MM-DD',
                      minDate: new Date()
                    });
                  });
                </script>
                <!-- My Profile -->
                <div class="col-xs-3">
                  <img class="img-circle" alt="profile" src="<%=current_user.image%>" style="width: 35px; height: 35px;">
                </div>
                <div class="col-xs-6">
                  <%=current_user.first_name%>
                </div>
                <div id="profile_me" class="col-xs-3 checkbox">
                  <%= check_box_tag('user_ids[]', current_user.id) %><br />
                </div>

                <!-- Others Profile -->
                <% temp.each_with_index do |t,idx| %>
                  <% if t.id != current_user.id %>
                    <div class="col-xs-3">
                      <img class="img-circle" alt="profile" src="<%=t.image%>" style="width: 35px; height: 35px;">
                    </div>
                    <div class="col-xs-6">
                      <%=t.first_name%>
                    </div>
                    <div id="profile_me" class="col-xs-3 checkbox">
                      <%= check_box_tag('user_ids[]', t.id) %>
                    </div>
                  <% end %>
                <% end %>
                <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
                <input type="hidden" name="team" value=<%=@team.id%>>
                <div class="col-sm-12">
                  <br>
                  <button type="submit" value="send" class="btn btn-new btn-sm" aria-haspopup="true" aria-expanded="false" style="width: 100%">
                    일 분배
                  </button>
                </div>
              </form>
            </div>
            <div class="row">
              <div class="col-sm-12">
                <hr />
                <% current_user.tasks.where(:team_id => @team.id).order(duedate: :asc).each_with_index do |b,i| %>
                  <% sender = User.find(b.sender)%>
                  <% if b.wansungdo < 100 %>
                    <% if b.duedate == nil %>
                      <% b.duedate = Date.today %>
                    <% end %>
                    <% a = (b.duedate - (Date.today)).to_i %>
                    <% if a > 0 %>
                      <div class="well well-sm">
                        <p>[<strong>D - <%=a%></strong>] <%=b.taskname%></p>
                        <div style="text-align: right">
                          <small>from</small> <img src="<%=sender.image.url%>" data-toggle="tooltip" data-placement="left" title="<%=sender.first_name%>" class="img img-circle" style="width: 20px;height: 20px;">
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-sm-10">
    <div style="text-align:center">
      <h3><%=@chat.title %></h3>
    </div>
    <div style="text-align:center">
      <div class="row">
        <div class="col-md-12">
          <% @chat.users.each do |inchat| %>
            <img class="img-circle" alt="profile" src="<%=inchat.image%>" data-toggle="tooltip" data-placement="bottom" title="<%=inchat.first_name%>" style="width: 25px; height: 25px;">
          <% end %>
          <span data-toggle="tooltip" data-placement="bottom" title="멤버 초대" ><button class="btn btn-new btn-xs" data-toggle="modal" data-target="#addmember2" type="button" type="button" ><span class="glyphicon glyphicon-plus"></span></button></span>






          <div id="addmember2" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
            <div class="modal-dialog modal-sm">

              <div class="modal-content">
                <div class="modal-header">
                  멤버 초대
                </div>

                <form action="/chat/addmember" method="post">
                  <div class="modal-body row">
                    <input type="hidden" name="chat" value="<%=@chat.id%>">
                    <input type="hidden" name="team" value="<%=@team.id%>">
                    <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

                    <% @team.users.each do |user| %>
                      <% if !@chat.users.include?(user)%>
                        <div class="col-sm-10">
                          <img class="img-circle" alt="profile" src="<%=user.image%>" style="width: 35px; height: 35px;">
                          <%=user.first_name%>
                        </div>
                        <div id="profile_me" class="col-sm-2 checkbox">
                          <%= check_box_tag('user_ids[]', user.id) %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" value="send" class="btn btn-new btn-sm" aria-haspopup="true" aria-expanded="false" style="width: 100%">
                      초대
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>



        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-6">
        <div style="text-align:center">채팅창</div>
        <div style="overflow:scroll; overflow-x:hidden; word-wrap:break-word; word-break:break-all; width:auto; height:400px;" id="chatbox">

          <% @chat.messages.each do |message| %>

            <%= sync partial: "newmessages", resource: message, scope: @chat %>

          <% end %>
          <div id="unloadmessages">

          </div>
          <%= sync_new partial: 'newmessages', resource: Message.new, scope: @chat%>
        </div>


          <%= form_for(:message, :url => {:controller => 'message', :action => 'create'}, :remote => true, :html => {:id => "messageform"}) do |f| %>
            <%= f.hidden_field :chat_id, :value => @chat.id %>
            <div class="form-group has-success has-feedback">
              <div class="dropup">
                <div class="input-group">
                  <span class="input-group-addon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    +
                  </span>
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                    <li><a><label for="fileupload" style="cursor: pointer;"><span class="glyphicon glyphicon-file"></span> 파일업로드</label></a></li>
                    <li><a><label for="imageupload" style="cursor: pointer;"><span class="glyphicon glyphicon-picture"></span> 사진업로드</label></a></li>
                  </ul>
                  <input type="text" name="message[content]" class="form-control" id="inputGroupSuccess1" aria-describedby="inputGroupSuccess1Status" autofocus required autocomplete="off">
                </div>
              </div>
            </div>

          <%end%>




        <form id="imagefileupload" class="form-inline" action="/imageup" method="post" enctype="multipart/form-data" data-remote="true">
          <input type="hidden" name="chat_id" value=<%= @chat.id %>>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

          <input id="imageupload" type="file" name="image_file" style="visibility:hidden;position:absolute;top:0;left:0;">
        </form>

        <form id="filefileupload" class="form-inline" action="/fileup" method="post" enctype="multipart/form-data" data-remote="true">
          <input type="hidden" name="chat_id" value=<%= @chat.id %>>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

          <input id="fileupload" type="file" name="file_file" style="visibility:hidden;position:absolute;top:0;left:0;">
        </form>

        <button type="hidden" style="visibility:hidden;position:absolute;top:0;left:0;" class="btn btn-primary btn-lg" id="imshow" data-toggle="modal" data-target="#myModal"></button>

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-body">
                <img id="blah" src="#" alt="your image" style="padding: 10px; max-width: 100%; height: auto;"/>
              </div>
              <div class="modal-footer">

                <button id="closemodal" type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                <button id="imagesubmit" type="button" onclick="$('#imagefileupload').submit();$('#closemodal').click(); this.disabled=true;" class="btn btn-primary">이미지 올리기</button>
              </div>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          $(document).ready(function(){
            $("#fileupload").on('click',function(){
              this.value=null;
            });
          })
          $(function(){
            $("#fileupload").on('change',function(){
              $("#filefileupload").submit();
            });
          });
          $(document).ready(function(){
            $("#imageupload").on('click',function(){
              this.value=null;
            });
          })
          $(function(){
            $("#imageupload").on('change',function(){
              $("#imagesubmit").prop('disabled', false);
              document.getElementById('imshow').click();
              readURL(this);
            });
          });
          function readURL(input){
            if(input.files && input.files[0]){
              var reader = new FileReader();
              reader.onload = function(e){
                $('#blah').attr('src',e.target.result);
              }
              reader.readAsDataURL(input.files[0]);
            }
          }
        </script>

        <script>
          $(document).ready(function(){
            $("#inputGroupSuccess1").keydown(function(event){
                if(event.keyCode == 13){
                  $("#messageform").submit();
                  $('#inputGroupSuccess1').val('');
                  return false;
                }
            });
          });
        </script>
      </div>
      <div class="col-sm-6">
        <div style="text-align:center">
          화이트 보드
          <%= sync partial: "whiteboardedit", resource: @whiteboard, scope: @chat, refetch: true %>

          <nav>
            <ul class="pagination pagination-sm">
              <li><%=sync partial: 'whiteboardcondition', resource: @whiteboard, scope: @chat, refetch: true%></li>
              <form action="/whiteboard/update2" method="post" id="whiteboardchangeform" data-remote=true>
                <input type="hidden" name="whiteboardid" value=<%=@whiteboard.id%>>
                <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
              </form>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <% if @chat.messages.count != 0 and @message%>
      <form action="/message/updateall" method="put" data-remote=true id="messagelookall">
        <input id="checkmessage" type="hidden" name="message_id" value=<%=@chat.messages.last.id%>>
        <input type="hidden" name="chat_id" value=<%=@chat.id%>>
        <input type="hidden" name="lastread" value="<%=@message.id%>">
	<input id="checkpoint" type="hidden" name="isupdate" value="false">
      </form>
    <% end %>


    <form action="/message/update" method="put" data-remote=true id="messagelook" class="newmessages">
      <input id="messagelookid" type="hidden" name="message_id" value=<%=@chat.messages.count-1%>>
      <input type="hidden" name="chat_id" value=<%=@chat.id%>>
      <input type="hidden" name="user_id" value=<%=current_user.id%>>
    </form>

    <script>
      $(document).ready(function(){
        <%if @message %>
            $('#chatbox').animate({ scrollTop: $('#message<%=@message.id%>').offset().top -200});
            $("#message<%=@message.id%>").append("-----------여기까지 읽었습니다-----------");
            $('.imagemessages:last').load(function(){
              $('#chatbox').animate({ scrollTop: $('#message<%=@message.id%>').offset().top -200});
            });
        <% end %>
        $("#whiteboardsend").click(function(){
          $("#whiteboardform").submit();
        });
        $("#whiteboardchange").click(function(){
          $("#whiteboardchangeform").submit();
        });
      });
      $(document).ready(function(){
        $('#messagelookall').submit();
      });

    function onmessage(x) {
      x.style.backgroundColor = "#F2F2F2";
    }
    function outmessage(x) {
      x.style.backgroundColor = "rgba(0,0,0,0)";

    }
    </script>


  </div>

</div>
